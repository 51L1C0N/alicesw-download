這是一份關於構建**「通用型模組化小說採集系統」**的架構設計總結。

根據您的要求，我們將系統徹底解耦，分為**「通用主引擎 (Core Engine)」**與**「站點適配插件 (Site Plugin)」**。這種設計確保了主程式的穩定性，同時保留了針對不同網站的靈活性。

以下是該系統的功能要點與架構總結：

### 🏛️ 1. 系統架構設計 (Modular Architecture)

系統將分為兩個獨立的檔案，實現邏輯分離：

* **主引擎 (Main Program)**：負責「怎麼抓」。包含所有通用邏輯（重試、延遲、存檔、日誌、排版優化）。這部分代碼寫好後通常**不需要修改**。
* **站點插件 (Site Adapter)**：負責「抓什麼」。針對特定網站編寫的規則（CSS 選擇器、目錄解析邏輯）。每次面對新網站，只需修改這個小文件。

---

### 🎛️ 2. 通用主引擎功能要點 (Core Engine Features)

主引擎負責指揮全局，具備以下通用能力：

#### A. 集中式配置管理 (Centralized Configuration)

* **參數統一**：所有可調整的開關（網址、檔名、Cookie 開關、排版開關、倒序開關）集中在配置區，一目了然。
* **動態加載**：主引擎讀取配置後，動態調用站點插件的規則。

#### B. 智慧網路請求與防護 (Smart Network & Anti-Ban)

* **循環式指數退避 (Cyclic Exponential Backoff)**：
* 遇到錯誤（如 50x, 403）時，等待時間按級別遞增（例如：5秒 -> 10秒 -> 20秒）。
* **循環機制**：達到最大等待時間後，若仍失敗，等待時間重置回初始值（5秒），防止無限等待。
* **成功重置**：一旦讀取成功，立即恢復為正常的隨機延遲模式。


* **身份偽裝**：
* **Cookie 注入**：支援掛載 `cookie.json` 進行身份驗證。
* **User-Agent 池**：內建 PC 與 Mobile 兩種瀏覽器標頭，可根據需求切換。



#### C. 任務管理與持久化 (Task Management)

* **斷點續傳 (Resume Capability)**：
* 在下載前檢查本地是否已有該章節內容。
* **跳過機制**：若章節已存在且內容完整，直接跳過（Skip），實現中斷後秒速恢復進度。


* **進度日誌 (Logging)**：
* 實時顯示下載進度（百分比/章節名）。
* 記錄錯誤日誌（哪一章失敗、原因為何），方便事後補抓。



#### D. 內容處理流水線 (Content Pipeline)

* **排版清洗開關**：提供 `Smart Layout` 開關。開啟時執行去干擾碼、合併斷行、縮進優化；關閉時保持原文格式。
* **檔案寫入**：採用追加模式（Append），確保數據實時落地，不會因為程式崩潰而丟失已下載內容。

---

### 🧩 3. 站點適配插件要點 (Site Plugin Requirements)

這是針對具體網站（如 Cool18 或 AliceSW）的特化模組，它只需要提供以下資訊給主引擎：

* **解析規則 (Parsers)**：
* **目錄解析**：如何從目錄頁提取出「章節列表」和「章節連結」。
* **正文解析**：如何從章節頁提取「小說標題」和「正文內容」。
* **分頁處理**：(可選) 針對單個帖子內有多個分頁的情況，定義如何獲取下一頁。


* **結構特徵 (Structure Flags)**：
* **順序標記**：告訴主引擎該網站的目錄是「正序」還是「倒序」（如論壇帖）。
* **編碼標記**：指定網站編碼（UTF-8 或 GBK），或設為自動偵測。



---

### 🚀 4. 運作流程總結 (Workflow)

1. **初始化**：主引擎啟動，載入 `cookie.json` 與用戶配置，載入指定的「站點插件」。
2. **目錄獲取**：主引擎調用插件的「目錄解析」功能，獲取所有待下載章節的 URL 列表。
3. **任務過濾**：主引擎檢查本地檔案，剔除已下載的章節（斷點續傳）。
4. **循環下載**：
* **請求**：主引擎發送請求（帶隨機延遲）。
* **失敗處理**：若失敗，進入「循環退避」模式死磕，直到成功。
* **解析**：請求成功後，將 HTML 丟給插件的「正文解析」功能，拿回純文字。
* **清洗**：主引擎根據設定決定是否執行排版修復。
* **存檔**：寫入硬碟，更新日誌。


5. **結束**：所有任務完成，輸出統計報告。

這套架構將**「變」與「不變」**徹底分開，下次您遇到新網站，我們只需要寫一個幾十行的「站點插件」，套上這個強大的主引擎即可運作。
